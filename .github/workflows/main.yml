name: GitHub Actions
run-name: ${{ github.actor }} is testing out ${{ github.repository }}

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - 'LICENSE.md'

jobs:
  Configure-Build-Install-Uninstall-Package-Upload:
    strategy:
      matrix:
          os:
            - ubuntu-latest
            - macos-15
            - windows-latest

          include:
            - os: ubuntu-latest
              generator: 'Unix Makefiles'
              triplet: x64-linux

            - os: macos-15
              generator: 'Ninja Multi-Config'
              triplet: x64-osx

            - os: windows-latest
              generator: 'Visual Studio 17 2022'
              triplet: x64-windows

          tag:
            - v1.92.2
            - v1.92.1
            - v1.92.0
            - v1.91.9
            - v1.91.8
            - v1.91.7
            - v1.91.6
            - v1.91.5
            - v1.91.4
            - v1.91.3
            - v1.91.2
            - v1.91.1
            - v1.91.0
            - v1.90.9
            - v1.90.8
            - v1.90.7
            - v1.90.6
            - v1.90.5
            - v1.90.4
            - v1.90.3
            - v1.90.2
            - v1.90.1
            - v1.90
            - v1.89.9
            - v1.89.8
            - v1.89.7
            - v1.89.6
            - v1.89.3
            - v1.89.2
            - v1.89.1
            - v1.89
            - v1.88
            - v1.87
            - v1.86
            - v1.84
            - v1.83
            - v1.82
            - v1.81
            - v1.80

          build-type:
            - Debug

    runs-on: ${{ matrix.os }}
    steps:
      - run: echo "Triggered by ${{ github.event_name }} on ${{ github.repository }} using ${{ github.ref}} branch and running on ${{ runner.os }}."

      - name: Install required packages on Ubuntu
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install --assume-yes --fix-missing libxinerama-dev libxcursor-dev mesa-common-dev xorg-dev libglu1-mesa-dev pkg-config libltdl-dev

      - name: Install required packages on macOS
        if: matrix.os == 'macos-15'
        run: brew install --cask xquartz

      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '4.0.0'

      - name: Install semver-tool for semantic version comparision
        uses: actions/checkout@v4
        with:
          repository: fsaintjacques/semver-tool
          show-progress: false
          path: semver-tool

      - name: Add it to the path
        shell: bash
        run: |
          chmod +x "$PWD/semver-tool/src/semver"
          echo "$PWD/semver-tool/src" >> $GITHUB_PATH

      - name: Make sure it's added to the path
        shell: bash
        run: semver --version

      - name: Check out ImGui repository
        uses: actions/checkout@v4
        with:
          repository: ocornut/imgui
          show-progress: false
          ref: ${{ matrix.tag }}
          path: imgui

      - name: Enable FreeType support on imconfig.h
        shell: bash
        run: |
          echo '#define IMGUI_ENABLE_FREETYPE' >> "${{ github.workspace }}/imgui/imconfig.h"

      - name: Check out CMakeForImGui
        uses: actions/checkout@v4
        with:
          show-progress: false
          path: CMakeForImGui

      - name: Setup vcpkg
        uses: johnwason/vcpkg-action@v7
        id: vcpkg
        with:
          manifest-dir: ${{ github.workspace }}/CMakeForImGui/.github/workflows
          triplet: ${{ matrix.triplet }}
          token: ${{ github.token }}

      - name: Configure
        run: >
          cmake
          -S ${{ github.workspace }}/CMakeForImGui
          -B ${{ github.workspace }}/build
          -G "${{ matrix.generator }}"
          -D VCPKG_MANIFEST_MODE=ON
          -D VCPKG_MANIFEST_DIR=${{ github.workspace }}/CMakeForImGui/.github/workflows
          -D CMAKE_INSTALL_PREFIX=${{ github.workspace }}/install.in.here
          -D IMGUI_SOURCE_DIR=${{ github.workspace }}/imgui
          -D install=ON
          -D install_examples=ON
          -D uninstall=ON
          -D DearImGui_Misc_Options=ON -D DearImGui_Misc_Cpp=ON -D DearImGui_Misc_FreeType=ON -D DearImGui_Misc_Debugger=ON -D DearImGui_Misc_Fonts=ON
          -D pkg-config=ON
          -D DearImGui_Backend_Allegro5=ON
          -D DearImGui_Backend_FreeGLUT=ON
          -D DearImGui_Backend_GLFW=ON
          -D DearImGui_Backend_OpenGL2=ON
          -D DearImGui_Backend_OpenGL3=ON
          -D DearImGui_Backend_Vulkan=ON
          -D DearImGui_Backend_SDL2=ON
          -D DearImGui_Backend_SDLRenderer2=ON
          -D DearImGui_Backend_SDL3=ON
          -D DearImGui_Backend_SDLGPU3=ON
          -D DearImGui_Backend_SDLRenderer3=ON
          -D DearImGui_Backend_WebGPU=OFF
          -D DearImGui_Examples=ON
          -D example_null=ON
          -D example_glfw_opengl2=ON -D example_glfw_opengl3=ON -D example_glfw_vulkan=ON -D example_glfw_metal=ON -D example_glfw_wgpu=OFF
          -D example_sdl2_opengl2=ON -D example_sdl2_opengl3=ON -D example_sdl2_vulkan=ON -D example_sdl2_metal=ON
          -D example_sdl3_opengl3=ON -D example_sdl3_vulkan=ON -D example_sdl3_metal=ON
          -D example_sdl3_sdlgpu3=ON
          -D example_sdl2_sdlrenderer2=ON
          -D example_sdl3_sdlrenderer3=ON
          -D example_glut_opengl2=ON
          -D example_allegro5=ON
          --toolchain ${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake

      - name: Configurations for macOS related backends
        if: matrix.os == 'macos-15'
        run: >
          cmake
          -S ${{ github.workspace }}/CMakeForImGui
          -B ${{ github.workspace }}/build
          -D DearImGui_Backend_Metal=ON
          -D DearImGui_Backend_OSX=ON
          -D example_apple_opengl2=ON
          -D example_apple_metal=ON

      - name: Configurations for Windows related backends
        if: matrix.os == 'windows-latest'
        run: >
          cmake
          -S ${{ github.workspace }}/CMakeForImGui
          -B ${{ github.workspace }}/build
          -D DearImGui_Backend_Win32=ON
          -D DearImGui_Backend_DirectX9=ON
          -D DearImGui_Backend_DirectX10=ON
          -D DearImGui_Backend_DirectX11=ON
          -D DearImGui_Backend_DirectX12=ON
          -D example_win32_opengl3=ON
          -D example_win32_vulkan=ON
          -D example_win32_directx9=ON
          -D example_win32_directx10=ON
          -D example_win32_directx11=ON
          -D example_win32_directx12=ON
          -D example_sdl2_directx11=ON


      - name: Check ImGui version whether ImPlot supported
        shell: bash
        id: is_implot_supported_by_this_version
        run: |
          version=${{ matrix.tag }}

          if [[ "$version" =~ ^v[0-9]+\.[0-9]+$ ]]; then
            version="${version}.0"
          fi

          result=$(semver compare $version v1.89.0)
          echo $result

          echo "result=$result" >> $GITHUB_OUTPUT

      - name: Checkout ImPlot
        if: steps.is_implot_supported_by_this_version.outputs.result == '1'
        uses: actions/checkout@v4
        with:
          repository: epezent/implot
          show-progress: false
          path: implot

      - name: Configure configure CMakeForImGui enabled ImPlot
        if: steps.is_implot_supported_by_this_version.outputs.result == '1'
        run: >
          cmake
          -S ${{ github.workspace }}/CMakeForImGui
          -B ${{ github.workspace }}/build
          -D thirdparty=ON
          -D implot=ON -D IMPLOT_SOURCE_DIR=$PWD/implot

      - name: Check ImGui version whether ImPlot3D supported
        shell: bash
        id: is_implot3d_supported_by_this_version
        run: |
          version=${{ matrix.tag }}

          if [[ "$version" =~ ^v[0-9]+\.[0-9]+$ ]]; then
            version="${version}.0"
          fi

          result=$(semver compare $version v1.90.0)
          echo $result

          echo "result=$result" >> $GITHUB_OUTPUT

      - name: Checkout ImPlot3D
        if: steps.is_implot3d_supported_by_this_version.outputs.result == '1'
        uses: actions/checkout@v4
        with:
          repository: brenocq/implot3d
          show-progress: false
          path: implot3d

      - name: Configure CMakeForImGui enabled ImPlot3D
        if: steps.is_implot3d_supported_by_this_version.outputs.result == '1'
        run: >
          cmake
          -S ${{ github.workspace }}/CMakeForImGui
          -B ${{ github.workspace }}/build
          -D thirdparty=ON
          -D implot3d=ON -D IMPLOT3D_SOURCE_DIR=$PWD/implot3d

      - name: Check ImGui version whether ImGuiFileDialog supported
        shell: bash
        id: is_imguifiledialog_supported_by_this_version
        run: |
          version=${{ matrix.tag }}

          if [[ "$version" =~ ^v[0-9]+\.[0-9]+$ ]]; then
            version="${version}.0"
          fi

          result=$(semver compare $version v1.92.0)
          echo $result

          echo "result=$result" >> $GITHUB_OUTPUT

      - name: Checkout ImGuiFileDialog
        if: steps.is_imguifiledialog_supported_by_this_version.outputs.result == '1'
        uses: actions/checkout@v4
        with:
          repository: aiekick/ImGuiFileDialog
          show-progress: false
          path: ImGuiFileDialog

      - name: Configure CMakeForImGui enabled ImGuiFileDialog
        if: steps.is_imguifiledialog_supported_by_this_version.outputs.result == '1'
        run: >
          cmake
          -S ${{ github.workspace }}/CMakeForImGui
          -B ${{ github.workspace }}/build
          -D thirdparty=ON
          -D imguifiledialog=ON -D IMGUIFILEDIALOG_SOURCE_DIR=$PWD/ImGuiFileDialog

      - name: Build
        run: >
          cmake
          --build ${{ github.workspace }}/build
          --config ${{ matrix.build-type }}

      - name: Fix install paths on Windows
        if: matrix.os == 'windows-latest'
        run: >
          (Get-Content -Path "${{ github.workspace }}\\build\\cmake_install.cmake")
          | ForEach-Object {$_ -replace 'D:\\a\\CMakeForImGui\\', 'D:/a/CMakeForImGui/'}
          | Set-Content -Path "${{ github.workspace }}\\build\\cmake_install.cmake"

      - name: Install
        run: >
          cmake
          --install ${{ github.workspace }}/build
          --config ${{ matrix.build-type }}

      - name: Uninstall
        run: >
          cmake
          --build ${{ github.workspace }}/build
          --target uninstall

      - name: Package
        run: >
          cmake
          --build ${{ github.workspace }}/build
          --target package
          --config ${{ matrix.build-type }}

      - name: Upload
        uses: actions/upload-artifact@v4

        with:
          name: build.imgui-${{ matrix.tag }}.${{ matrix.os }}.${{ matrix.triplet }}.${{ matrix.build-type }}
          path: ${{ github.workspace }}/build/package

      - run: echo "Job exited by ${{ job.status }}."

  Build-Android-example:
    runs-on: ubuntu-latest
    steps:
      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '4.0.0'

      - name: Check out ImGui repository
        uses: actions/checkout@v4
        with:
          repository: ocornut/imgui
          show-progress: false
          path: imgui

      - name: Check out CMakeForImGui
        uses: actions/checkout@v4
        with:
          show-progress: false
          path: CMakeForImGui

      - name: Configure
        run: >
          cmake
          -S ${{ github.workspace }}/CMakeForImGui
          -B ${{ github.workspace }}/build
          -D IMGUI_SOURCE_DIR=${{ github.workspace }}/imgui
          -D DearImGui_Backend_Android=ON
          -D DearImGui_Backend_OpenGL3=ON
          -D DearImGui_Examples=ON
          -D example_android_opengl3=ON
          --toolchain ${ANDROID_NDK_ROOT}/build/cmake/android.toolchain.cmake

      - name: Build
        run: >
          cmake
          --build ${{ github.workspace }}/build

      - name: Upload
        uses: actions/upload-artifact@v4

        with:
          name: example_android_opengl3
          path: ${{ github.workspace }}/imgui/examples/example_android_opengl3/android/app/build/outputs/apk

